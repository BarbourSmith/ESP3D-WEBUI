<script type="text/javascript">
    function sendMessage(msg){ 
		window.parent.postMessage(msg, '*');
        if (msg.type=="cmd"){ 
			const resultPanel = document.getElementById("terminal");
			resultPanel.innerHTML = resultPanel.innerHTML + "<br>" + msg.content.replace("\n", "<br/>").replace("\r", "")  ;
			resultPanel.scrollTop = resultPanel.scrollHeight
		}
    };
    function processMessage(eventMsg){
        if (eventMsg.data.type  && (!eventMsg.data.id||eventMsg.data.id=="term")){
            if (eventMsg.data.type=="response"){
				const line =  eventMsg.data.content.response
				const resultPanel = document.getElementById("terminal");
				resultPanel.innerHTML = resultPanel.innerHTML + "<br>" + line.replace("\n", "<br/>") ;
				resultPanel.scrollTop = resultPanel.scrollHeight
			}
			if (eventMsg.data.type=="upload" || eventMsg.data.type=="query"){
				console.log(eventMsg.data);
			}
			if (eventMsg.data.type=="download"){
				console.log(eventMsg.data)
				console.log(eventMsg.data.content.status)
				if (eventMsg.data.content.status=="success"){
					//just read it
					var reader = new FileReader();
					reader.onload = function() {
						console.log(reader.result);
					}
					reader.readAsText(eventMsg.data.content.blob);
				//save it
				 
                  if (window.navigator.msSaveOrOpenBlob)
                    // IE10+
                    window.navigator.msSaveOrOpenBlob(eventMsg.data.content.blob, eventMsg.data.content.url);
                  else {
                    // Others
                    const a = document.createElement("a");
                    const url = URL.createObjectURL(eventMsg.data.content.blob);
                    a.href = url;
                    a.download = eventMsg.data.content.url;
                    a.onload = () => {
                      URL.revokeObjectURL(a.href);
                    };
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(function () {
                      document.body.removeChild(a);
                      window.URL.revokeObjectURL(url);
                    }, 0);
                  }
				
				
				}
			}
			
			if (eventMsg.data.type=="translate" ){
				console.log(eventMsg.data);
			}
			
			if (eventMsg.data.type=="modal" ){
				console.log(eventMsg.data);
				if (eventMsg.data.content.style=="input" && eventMsg.data.content.response=="send")sendMessage({type:'modal',modal:{title:'Modal Dialog', id:'termModal',style:'default',bt1Txt:'ok', response1:'ok', text:'You sent:'+eventMsg.data.content.inputData},target:'webui',  id:'term'});
			}
        }
    }
    function sendCommand(){
        sendMessage({type:'cmd', content:document.getElementById("command").value, target:"webui", });
        document.getElementById('command').value=''; 
    }
    
    function uploadFile(){
		const files = document.getElementById("uploadBtn").files
		if (files.length>0){
			const reader = new FileReader();
            reader.onload = function (e) {
		        window.parent.postMessage({type:'upload', target:"webui", content:e.target.result,size:e.target.result.byteLength, path:"/", filename:files[0].name, id:'term'}, "*");
		        document.getElementById("uploadBtn").value="";
		    }
		    reader.readAsArrayBuffer(files[0]);
	    }myModal
      };
      

    window.addEventListener("message", processMessage, false)
    
</script>
<div class="container">
    <button class="btn m-1" onclick="sendMessage({type:'query', url:'files', args:{action:'list', path:'/'}, target:'webui', id:'term'});">List Files</button>
    <button class="btn m-1" onclick="sendMessage({type:'download',url:'preferences.json', target:'webui',id:'term'});">download preferences.json</button>
    <button class="btn m-1" onclick="sendMessage({type:'cmd', content:'[ESP111]', id:'term', target:'webui' });">[ESP111]</button>
    <button class="btn m-1" onclick="document.getElementById('uploadBtn').click();">Upload</button>
    <input type="file" class="d-none" id="uploadBtn" onChange="uploadFile()" />
    <button class="btn m-1" onclick="sendMessage({type:'toast', toast:{content:'This is an error', type:'error'}, target:'webui', id:'term'});">Error Toast</button>
    <button class="btn m-1" onclick="sendMessage({type:'toast', toast:{content:'This is a success', type:'success'}, target:'webui', id:'term'});">Success Toast</button>
    <button class="btn m-1" onclick="sendMessage({type:'toast', toast:{content:'This is a toast', type:'default'}, target:'webui', id:'term'});">Classic Toast</button>
    <button class="btn m-1" onclick="sendMessage({type:'translate', content:'Settings', target:'webui', id:'term'});">Translate Settings</button>
    <button class="btn m-1" onclick="sendMessage({type:'beep', sound:'beep', target:'webui', id:'term'});">Beep</button>
    <button class="btn m-1" onclick="sendMessage({type:'beep', sound:'error', target:'webui', id:'term'});">Beep Error</button>
    <button class="btn m-1" onclick="sendMessage({type:'beep', sound:'seq', seq:[{ f: 1046, d: 200 },{ f: 1318, d: 100 }],target:'webui',  id:'term'});">Beep Seq</button>
    <button class="btn m-1" onclick="sendMessage({type:'modal',modal:{title:'This is tile', id:'termModal',style:'default',bt1Txt:'ok', response1:'ok', text:'some text', overlay:true},target:'webui',  id:'term'});">Simple Modal</button>
    <button class="btn m-1" onclick="sendMessage({type:'modal',modal:{title:'Please confirm', id:'termModal',style:'question',bt1Txt:'yes', response1:'yes',bt2Txt:'cancel', response2:'cancel', text:'You only can confirm',hideclose:true},target:'webui',  id:'term'});">Confirmation Modal</button>
    <button class="btn m-1" onclick="sendMessage({type:'modal',modal:{title:'Please enter Text', id:'termModal',style:'input',bt1Txt:'Send', response1:'send',bt2Txt:'Cancel', response2:'cancel', text:'The text will be send back',hideclose:true},target:'webui',  id:'term'});">Input Modal</button>
   
    <div class="input-group">
        <input type="text" class="form-input" id="command"  />
        <button class="btn btn-black input-group-btn" onclick="sendCommand()">Send</button>
    </div>
    <div class="container m-2">
    <pre id="terminal" class="bg-primary p-2" style="min-height: 200px;"></pre>
    </div>
</div>

